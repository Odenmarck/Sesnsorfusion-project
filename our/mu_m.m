

function [x, P] = mu_m(x, P, mag, m0, Rm)
   f = zeros(3,1);
    %
   H = [4*x(1)*(f(1) + m0(1)) + 2*x(4)*(f(2) + m0(2)) - 2*x(3)*(f(3) + m0(3)), 4*x(2)*(f(1) + m0(1)) + 2*x(3)*(f(2) + m0(2)) + 2*x(4)*(f(3) + m0(3)),                  2*x(2)*(f(2) + m0(2)) - 2*x(1)*(f(3) + m0(3)),                  2*x(1)*(f(2) + m0(2)) + 2*x(2)*(f(3) + m0(3));
         4*x(1)*(f(2) + m0(2)) - 2*x(4)*(f(1) + m0(1)) + 2*x(2)*(f(3) + m0(3)),                  2*x(3)*(f(1) + m0(1)) + 2*x(1)*(f(3) + m0(3)), 2*x(2)*(f(1) + m0(1)) + 4*x(3)*(f(2) + m0(2)) + 2*x(4)*(f(3) + m0(3)),                  2*x(3)*(f(3) + m0(3)) - 2*x(1)*(f(1) + m0(1));
         2*x(3)*(f(1) + m0(1)) - 2*x(2)*(f(2) + m0(2)) + 4*x(1)*(f(3) + m0(3)),                  2*x(4)*(f(1) + m0(1)) - 2*x(1)*(f(2) + m0(2)),                  2*x(1)*(f(1) + m0(1)) + 2*x(4)*(f(2) + m0(2)), 2*x(2)*(f(1) + m0(1)) + 2*x(3)*(f(2) + m0(2)) + 4*x(4)*(f(3) + m0(3))];

    %

    Qq_transpose = [2*x(1)^2 + 2*x(2)^2 - 1,   2*x(1)*x(4) + 2*x(2)*x(3),   2*x(2)*x(4) - 2*x(1)*x(3);
      2*x(2)*x(3) - 2*x(1)*x(4), 2*x(1)^2 + 2*x(3)^2 - 1,   2*x(1)*x(2) + 2*x(3)*x(4);
      2*x(1)*x(3) + 2*x(2)*x(4),   2*x(3)*x(4) - 2*x(1)*x(2), 2*x(1)^2 + 2*x(4)^2 - 1];

    S = H*P*H.' + Rm;
    K = (P*H.')/S;
    
    mag_hat = Qq_transpose*(m0 + f);
    x = x + K*(mag - mag_hat);
    P = P-K*S*K.';
    [x, P] = mu_normalizeQ(x, P);
